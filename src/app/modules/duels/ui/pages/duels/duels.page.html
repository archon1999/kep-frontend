<div class="content-wrapper container-xxl p-0">
  <div class="content-body duels-page">
    <app-content-header [contentHeader]="contentHeader">
      <div class="btn-list">
        <a
          [ngClass.lt-md]="'btn-sm'"
          class="btn btn-primary-light"
          [routerLink]="['/practice', 'duels', 'rating']"
        >
          <kep-icon class="font-medium-1" name="ranking"></kep-icon>
          <span [ngClass.lt-md]="'d-none'">
            {{ 'Rating' | translate }}
          </span>
        </a>
      </div>
    </app-content-header>

    <div class="row">
      <div class="col-12">
        <duel-ready-status-card
          [isReady]="isReady"
          [disabled]="readyStatusLoading"
          (readyChange)="onReadyStatusChange($event)"
        ></duel-ready-status-card>
      </div>

      <div class="col-12">
        <duel-ready-players-section
          [players]="readyPlayersResult?.data ?? []"
          [total]="readyPlayersTotal"
          [page]="readyPlayersPage"
          [pageSize]="readyPlayersPageSize"
          [loading]="readyPlayersLoading"
          [currentUsername]="currentUser?.username ?? null"
          (pageChange)="loadReadyPlayers($event)"
          (challenge)="openDuelModal($event)"
        />
      </div>

      <div class="col-12 col-xl-6">
        <duels-list-section
          [duels]="duelsResult?.data ?? []"
          [total]="duelsTotal"
          [page]="duelsPage"
          [pageSize]="duelsPageSize"
          [loading]="duelsLoading"
          [confirmLoadingId]="confirmLoadingId"
          [currentUsername]="currentUser?.username ?? null"
          (pageChange)="loadDuels($event)"
          (confirm)="confirmDuel($event)"
        />
      </div>

      <div class="col-12 col-xl-6">
        <duels-list-section
          titleKey="AllDuels"
          [duels]="allDuelsResult?.data ?? []"
          [total]="allDuelsTotal"
          [page]="allDuelsPage"
          [pageSize]="allDuelsPageSize"
          [loading]="allDuelsLoading"
          [confirmLoadingId]="confirmLoadingId"
          [currentUsername]="currentUser?.username ?? null"
          (pageChange)="loadAllDuels($event)"
          (confirm)="confirmDuel($event)"
        />
      </div>
    </div>
  </div>
</div>

<ng-template #duelPresetModal>
  <div class="modal-header">
    <h5 class="modal-title">{{ 'SelectDuelPreset' | translate }}</h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="closeModal()"></button>
  </div>
  <form [formGroup]="duelForm" (ngSubmit)="createDuel()">
    <div class="modal-body">
      <p class="text-muted mb-3">
        {{ 'SelectDuelPresetDescription' | translate:{ username: selectedOpponent?.username } }}
      </p>
      @if (duelPresetsLoading) {
        <div class="d-flex justify-content-center py-3">
          <spinner></spinner>
        </div>
      } @else {
        <div class="mb-3">
          @if (duelPresets.length) {
            @for (preset of duelPresets; track preset.id) {
              <div class="form-check border rounded p-3 mb-2" [class.border-primary]="duelControls.presetId.value === preset.id">
                <input
                  class="form-check-input"
                  type="radio"
                  [value]="preset.id"
                  formControlName="presetId"
                  [id]="'preset-' + preset.id"
                >
                <label class="form-check-label w-100" [for]="'preset-' + preset.id">
                  <div class="d-flex justify-content-between align-items-center">
                    <span class="fw-semibold">{{ preset.title }}</span>
                    <span class="text-warning">{{ preset.difficultyDisplay }}</span>
                  </div>
                  @if (preset.category?.title) {
                    <div class="text-muted small">{{ preset.category.title }}</div>
                  }
                  <div class="text-muted small">
                    {{ 'Problems' | translate }}: {{ preset.problemsCount }} Â· {{ 'Duration' | translate }}: {{ preset.duration }}
                  </div>
                </label>
              </div>
            }
          } @else {
            <div class="text-muted">{{ 'NoPresetsAvailable' | translate }}</div>
          }
          @if (duelControls.presetId.invalid && duelControls.presetId.touched) {
            <div class="text-danger small">{{ 'FieldRequired' | translate }}</div>
          }
        </div>
      }
      <div class="mb-0">
        <label class="form-label" for="duelStartTime">{{ 'StartTime' | translate }}</label>
        <input
          type="datetime-local"
          id="duelStartTime"
          class="form-control"
          formControlName="startTime"
          [min]="minStartTime"
        >
        @if (duelControls.startTime.invalid && duelControls.startTime.touched) {
          <div class="text-danger small mt-1">{{ 'FieldRequired' | translate }}</div>
        }
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-outline-secondary" (click)="closeModal()">{{ 'Cancel' | translate }}</button>
      <button type="submit" class="btn btn-primary" [disabled]="duelForm.invalid || duelPresetsLoading">
        {{ 'CreateDuel' | translate }}
      </button>
    </div>
  </form>
</ng-template>
