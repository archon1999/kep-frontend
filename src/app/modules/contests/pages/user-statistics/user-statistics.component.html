<div class="content-wrapper container-xxl p-0">
  <div class="content-body">
    <app-content-header [contentHeader]="contentHeader"></app-content-header>

    @if (isLoading) {
      <kep-card [cardHeight]="'320px'">
        <div class="card-body d-flex align-items-center justify-content-center">
          <spinner></spinner>
        </div>
      </kep-card>
    } @else if (statistics) {
      <div class="row g-2 g-lg-3 mb-3">
        @for (card of generalCards; track card.key) {
          <div class="col-sm-6 col-xl-3">
            <kep-card>
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <div class="text-muted text-uppercase small mb-1">{{ card.label | translate }}</div>
                    <div class="fw-bolder fs-3">{{ card.value }}</div>
                    @if (card.subtitle) {
                      <div class="text-muted small">{{ card.subtitle }}</div>
                    }
                  </div>
                  <kep-icon [name]="card.icon" class="font-large-1 text-primary"></kep-icon>
                </div>
              </div>
            </kep-card>
          </div>
        }
      </div>

      <div class="row g-2 g-lg-3 mb-3">
        @for (card of overviewCards; track card.key) {
          <div class="col-sm-6 col-xl-3">
            <kep-card>
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <div class="text-muted text-uppercase small mb-1">{{ card.label | translate }}</div>
                    <div class="fw-bolder fs-3">{{ card.value }}</div>
                    @if (card.subtitle) {
                      <div class="text-muted small">{{ card.subtitle }}</div>
                    }
                  </div>
                  <kep-icon [name]="card.icon" class="font-large-1 text-primary"></kep-icon>
                </div>
              </div>
            </kep-card>
          </div>
        }
      </div>

      <div class="row g-2 g-lg-3 mb-3">
        @for (card of highlightCards; track card.key) {
          <div class="col-lg-4 col-md-6">
            <kep-card>
              <div class="card-body">
                <div class="d-flex align-items-start gap-2">
                  <kep-icon [name]="card.icon" class="font-large-1 text-primary"></kep-icon>
                  <div class="flex-grow-1">
                    <div class="text-muted text-uppercase small mb-1">{{ card.label | translate }}</div>
                    @if (card.valueLabel) {
                      <div class="fw-bolder">{{ card.valueLabel }}</div>
                    } @else {
                      <div class="fw-bolder">{{ 'Contests.UserStatistics.NoData' | translate }}</div>
                    }
                    @if (card.contestLink && card.contestTitle) {
                      <a class="text-primary small d-block" [routerLink]="card.contestLink">{{ card.contestTitle }}</a>
                    } @else if (card.contestTitle) {
                      <div class="text-muted small">{{ card.contestTitle }}</div>
                    }
                    @if (card.meta) {
                      <div class="text-muted small">{{ card.meta }}</div>
                    }
                  </div>
                </div>
              </div>
            </kep-card>
          </div>
        }
      </div>

      <div class="row g-2 g-lg-3 mb-3">
        <div class="col-lg-6">
          <kep-card>
            <div class="card-header">
              <div class="card-title">{{ 'Contests.UserStatistics.ContestRanks' | translate }}</div>
            </div>
            <div class="card-body">
              <div class="d-flex flex-column gap-3">
                @for (card of contestRankCards; track card.key) {
                  <div class="d-flex align-items-start gap-2">
                    <kep-icon [name]="card.icon" class="text-primary"></kep-icon>
                    <div class="flex-grow-1">
                      <div class="fw-bolder">{{ card.label | translate }}</div>
                      @if (card.value) {
                        <div class="fs-4 fw-bolder">{{ card.value }}</div>
                      } @else {
                        <div class="text-muted small">{{ 'Contests.UserStatistics.NoData' | translate }}</div>
                      }
                      @if (card.contestLink && card.contestTitle) {
                        <a class="text-primary small d-block" [routerLink]="card.contestLink">{{ card.contestTitle }}</a>
                      } @else if (card.contestTitle) {
                        <div class="text-muted small">{{ card.contestTitle }}</div>
                      }
                      @if (card.subtitle) {
                        <div class="text-muted small">{{ card.subtitle }}</div>
                      }
                    </div>
                  </div>
                }
              </div>
            </div>
          </kep-card>
        </div>
        <div class="col-lg-6">
          <kep-card>
            <div class="card-header">
              <div class="card-title">{{ 'Contests.UserStatistics.RatingChanges' | translate }}</div>
            </div>
            <div class="card-body">
              <div class="d-flex flex-column gap-3">
                @for (card of contestDeltaCards; track card.key) {
                  <div class="d-flex align-items-start gap-2">
                    <kep-icon [name]="card.icon" class="text-primary"></kep-icon>
                    <div class="flex-grow-1">
                      <div class="fw-bolder">{{ card.label | translate }}</div>
                      @if (card.value) {
                        <div class="fs-4 fw-bolder" [ngClass]="{'text-success': card.key === 'bestDelta', 'text-danger': card.key === 'worstDelta'}">{{ card.value }}</div>
                      } @else {
                        <div class="text-muted small">{{ 'Contests.UserStatistics.NoData' | translate }}</div>
                      }
                      @if (card.contestLink && card.contestTitle) {
                        <a class="text-primary small d-block" [routerLink]="card.contestLink">{{ card.contestTitle }}</a>
                      } @else if (card.contestTitle) {
                        <div class="text-muted small">{{ card.contestTitle }}</div>
                      }
                      @if (card.subtitle) {
                        <div class="text-muted small">{{ card.subtitle }}</div>
                      }
                    </div>
                  </div>
                }
              </div>
            </div>
          </kep-card>
        </div>
      </div>

      <div class="row g-2 g-lg-3 mb-3">
        <div class="col-lg-8">
          <kep-card>
            <div class="card-header">
              <div class="card-title">{{ 'Contests.AttemptsTimeline' | translate }}</div>
              <div class="text-muted small">{{ statistics.overview.totalAttempts | number }} {{ 'Attempts' | translate }}</div>
            </div>
            <div class="card-body p-2">
              @if (timelineChart) {
                <apex-chart [options]="timelineChart"></apex-chart>
              } @else {
                <div class="text-center text-muted py-4">{{ 'Contests.UserStatistics.NoData' | translate }}</div>
              }
            </div>
          </kep-card>
        </div>
        <div class="col-lg-4">
          <kep-card>
            <div class="card-header">
              <div class="card-title">{{ 'Contests.UserStatistics.Languages' | translate }}</div>
            </div>
            <div class="card-body p-2">
              @if (languagesChart) {
                <apex-chart [options]="languagesChart"></apex-chart>
              } @else {
                <div class="text-center text-muted py-4">{{ 'Contests.UserStatistics.NoData' | translate }}</div>
              }
            </div>
          </kep-card>
        </div>
      </div>

      <div class="row g-2 g-lg-3 mb-3">
        <div class="col-lg-4">
          <kep-card>
            <div class="card-header">
              <div class="card-title">{{ 'Contests.VerdictDistribution' | translate }}</div>
            </div>
            <div class="card-body p-2">
              @if (verdictsChart) {
                <apex-chart [options]="verdictsChart"></apex-chart>
              } @else {
                <div class="text-center text-muted py-4">{{ 'Contests.UserStatistics.NoData' | translate }}</div>
              }
            </div>
          </kep-card>
        </div>
        <div class="col-lg-4">
          <kep-card>
            <div class="card-header">
              <div class="card-title">{{ 'Contests.UserStatistics.Tags' | translate }}</div>
            </div>
            <div class="card-body">
              @if (topTags.length) {
                <div class="d-flex flex-column gap-2">
                  @for (tag of topTags; track tag.name) {
                    <div class="d-flex justify-content-between align-items-center">
                      <span>{{ tag.name }}</span>
                      <span class="badge bg-light text-dark">{{ tag.solved }}</span>
                    </div>
                  }
                </div>
              } @else {
                <div class="text-center text-muted py-4">{{ 'Contests.UserStatistics.NoData' | translate }}</div>
              }
            </div>
          </kep-card>
        </div>
        <div class="col-lg-4">
          <kep-card>
            <div class="card-header">
              <div class="card-title">{{ 'Contests.UserStatistics.Symbols' | translate }}</div>
            </div>
            <div class="card-body">
              @if (topSymbols.length) {
                <div class="d-flex flex-column gap-2">
                  @for (symbol of topSymbols; track symbol.symbol) {
                    <div class="d-flex justify-content-between align-items-center">
                      <span>{{ symbol.symbol }}</span>
                      <span class="badge bg-light text-dark">{{ symbol.solved }}</span>
                    </div>
                  }
                </div>
              } @else {
                <div class="text-center text-muted py-4">{{ 'Contests.UserStatistics.NoData' | translate }}</div>
              }
            </div>
          </kep-card>
        </div>
      </div>

      <div class="row g-2 g-lg-3 mb-3">
        <div class="col-lg-6">
          <kep-card>
            <div class="card-header">
              <div class="card-title">{{ 'Contests.UserStatistics.UnsolvedProblems' | translate }}</div>
            </div>
            <div class="card-body">
              @if (statistics.unsolvedProblems.length) {
                <div class="d-flex flex-column gap-2">
                  @for (problem of statistics.unsolvedProblems; track problem.contestId + problem.problemSymbol) {
                    <div class="d-flex flex-wrap justify-content-between align-items-center gap-1">
                      <div class="fw-bolder">{{ problem.problemSymbol }}</div>
                      <a class="text-primary small" [routerLink]="getContestProblemLink(problem.contestId, problem.problemSymbol)">
                        {{ problem.contestTitle }}
                      </a>
                    </div>
                  }
                </div>
              } @else {
                <div class="text-center text-muted py-4">{{ 'Contests.UserStatistics.NoUnsolvedProblems' | translate }}</div>
              }
            </div>
          </kep-card>
        </div>
        <div class="col-lg-6">
          <kep-card>
            <div class="card-header">
              <div class="card-title">{{ 'Contests.UserStatistics.TopAttempts' | translate }}</div>
            </div>
            <div class="card-body">
              @if (statistics.topAttempts.length) {
                <div class="d-flex flex-column gap-2">
                  @for (attempt of statistics.topAttempts; track attempt.contestId + attempt.problemSymbol) {
                    <div class="d-flex flex-column">
                      <div class="d-flex justify-content-between align-items-center">
                        <div class="fw-bolder">{{ attempt.problemSymbol }}</div>
                        <span class="badge" [ngClass]="attempt.solved ? 'bg-success' : 'bg-danger'">
                          {{ attempt.solved ? ('Solved' | translate) : ('Contests.UserStatistics.Unsolved' | translate) }}
                        </span>
                      </div>
                      <div class="d-flex justify-content-between small text-muted">
                        <span>{{ attempt.attemptsCount | number }} {{ 'Attempts' | translate }}</span>
                        <a class="text-primary" [routerLink]="getContestProblemLink(attempt.contestId, attempt.problemSymbol)">{{ attempt.contestTitle }}</a>
                      </div>
                    </div>
                  }
                </div>
              } @else {
                <div class="text-center text-muted py-4">{{ 'Contests.UserStatistics.NoData' | translate }}</div>
              }
            </div>
          </kep-card>
        </div>
      </div>

      <div class="row g-2 g-lg-3">
        <div class="col-12">
          <kep-card>
            <div class="card-header">
              <div class="card-title">{{ 'Contests.UserStatistics.WorthyOpponents' | translate }}</div>
            </div>
            <div class="card-body">
              @if (topOpponents.length) {
                <div class="d-flex flex-column gap-3">
                  @for (opponent of topOpponents; track opponent.opponent) {
                    <div class="p-2 rounded border">
                      <div class="d-flex justify-content-between align-items-center mb-1">
                        <div class="fw-bolder">{{ opponent.opponent }}</div>
                        <span class="badge bg-primary">{{ opponent.sharedCount }} {{ 'Contests.UserStatistics.SharedContests' | translate }}</span>
                      </div>
                      <div class="d-flex flex-column gap-1">
                        @for (contest of opponent.contests; track contest.contestId) {
                          <div class="d-flex flex-wrap justify-content-between gap-1">
                            <a class="text-primary" [routerLink]="getContestLink(contest.contestId)">{{ contest.contestTitle }}</a>
                            <div class="text-muted small">
                              {{ 'Rank' | translate }}: #{{ contest.userRank }} · #{{ contest.opponentRank }}
                            </div>
                            <div class="text-muted small">
                              {{ 'Points' | translate }}: {{ contest.userPoints }} — {{ contest.opponentPoints }}
                            </div>
                          </div>
                        }
                      </div>
                    </div>
                  }
                </div>
              } @else {
                <div class="text-center text-muted py-4">{{ 'Contests.UserStatistics.NoOpponents' | translate }}</div>
              }
            </div>
          </kep-card>
        </div>
      </div>
    }
  </div>
</div>
