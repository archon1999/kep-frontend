<div class="content-wrapper container-xxl p-0">
  <div class="content-body">
    <app-content-header [contentHeader]="contentHeader"></app-content-header>

    @if (isLoading) {
      <kep-card>
        <div class="card-body d-flex justify-content-center align-items-center" [style.minHeight.px]="360">
          <spinner></spinner>
        </div>
      </kep-card>
    } @else if (statistics) {
      <section class="mt-2 d-flex flex-column gap-3">
        <div class="row g-3">
          @for (card of overviewCards; track card.key) {
            <div class="col-12 col-sm-6 col-xl-3">
              <kep-card customClass="h-100">
                <div class="card-header">
                  <div class="card-title d-flex align-items-center gap-1">
                    <kep-icon [name]="card.icon" size="small-3"></kep-icon>
                    {{ card.titleKey | translate }}
                  </div>
                </div>
                <div class="card-body d-flex flex-column gap-1">
                  <div class="display-6 fw-semibold">
                    @if (card.isNumber) {
                      {{ card.value | number }}
                    } @else {
                      {{ card.value }}
                    }
                  </div>
                  @if (card.subtitle) {
                    <div class="text-muted small">{{ card.subtitle }}</div>
                  }
                  @if (card.subtitleKey) {
                    <div class="text-muted small">{{ card.subtitleKey | translate:card.subtitleParams }}</div>
                  }
                </div>
              </kep-card>
            </div>
          }
        </div>

        <div class="row g-3">
          <div class="col-12 col-xl-8">
            <kep-card>
              <div class="card-header">
                <div class="card-title d-flex align-items-center gap-1">
                  <kep-icon name="statistics" size="small-3"></kep-icon>
                  {{ 'Contests.UserStats.PerformanceHighlights' | translate }}
                </div>
              </div>
              <div class="card-body">
                <div class="d-flex flex-column gap-3">
                  <div class="d-flex gap-3 align-items-center">
                    <div class="rounded-circle bg-light-info d-flex align-items-center justify-content-center" style="width: 42px; height: 42px;">
                      <kep-icon name="statistics" color="info"></kep-icon>
                    </div>
                    <div>
                      <div class="fw-semibold">{{ 'Contests.UserStats.AverageAttemptsPerProblem' | translate }}</div>
                      <div class="text-muted small">{{ statistics.overview.averageAttemptsPerProblem | number:'1.2-2' }}</div>
                    </div>
                  </div>

                  @if (statistics.overview.singleAttemptProblems) {
                    <div class="d-flex gap-3 align-items-center">
                      <div class="rounded-circle bg-light-success d-flex align-items-center justify-content-center" style="width: 42px; height: 42px;">
                        <kep-icon name="attempt" color="success"></kep-icon>
                      </div>
                      <div>
                        <div class="fw-semibold">{{ 'Contests.UserStats.SingleAttemptProblems' | translate }}</div>
                        <div class="text-muted small">
                          {{ statistics.overview.singleAttemptProblems.count | number }} 路
                          {{ statistics.overview.singleAttemptProblems.percentage | number:'1.0-2' }}%
                        </div>
                      </div>
                    </div>
                  }

                  @if (statistics.overview.mostAttemptsProblem) {
                    <div class="d-flex gap-3 align-items-center">
                      <div class="rounded-circle bg-light-warning d-flex align-items-center justify-content-center" style="width: 42px; height: 42px;">
                        <kep-icon name="attempts" color="warning"></kep-icon>
                      </div>
                      <div>
                        <div class="fw-semibold">{{ 'Contests.UserStats.MostAttemptsProblem' | translate }}</div>
                        <div class="text-muted small">{{ statistics.overview.mostAttemptsProblem.contestTitle }}</div>
                        <div class="text-muted small">
                          {{ 'Contests.UserStats.ProblemSymbol' | translate:{ symbol: statistics.overview.mostAttemptsProblem.problemSymbol } }} 路
                          {{ 'Contests.UserStats.AttemptsCount' | translate:{ count: statistics.overview.mostAttemptsProblem.attemptsCount } }}
                        </div>
                      </div>
                    </div>
                  }

                  @if (statistics.overview.fastestSolve) {
                    <div class="d-flex gap-3 align-items-center">
                      <div class="rounded-circle bg-light-primary d-flex align-items-center justify-content-center" style="width: 42px; height: 42px;">
                        <kep-icon name="contest" color="primary"></kep-icon>
                      </div>
                      <div>
                        <div class="fw-semibold">{{ 'Contests.UserStats.FastestSolve' | translate }}</div>
                        <div class="text-muted small">{{ statistics.overview.fastestSolve.contestTitle }}</div>
                        <div class="text-muted small">
                          {{ 'Contests.UserStats.ProblemSymbol' | translate:{ symbol: statistics.overview.fastestSolve.problemSymbol } }} 路
                          {{ statistics.overview.fastestSolve.time }}
                        </div>
                      </div>
                    </div>
                  }

                  @if (statistics.overview.slowestSolve) {
                    <div class="d-flex gap-3 align-items-center">
                      <div class="rounded-circle bg-light-danger d-flex align-items-center justify-content-center" style="width: 42px; height: 42px;">
                        <kep-icon name="contest" color="danger"></kep-icon>
                      </div>
                      <div>
                        <div class="fw-semibold">{{ 'Contests.UserStats.SlowestSolve' | translate }}</div>
                        <div class="text-muted small">{{ statistics.overview.slowestSolve.contestTitle }}</div>
                        <div class="text-muted small">
                          {{ 'Contests.UserStats.ProblemSymbol' | translate:{ symbol: statistics.overview.slowestSolve.problemSymbol } }} 路
                          {{ statistics.overview.slowestSolve.time }}
                        </div>
                      </div>
                    </div>
                  }
                </div>
              </div>
            </kep-card>
          </div>

          <div class="col-12 col-xl-4">
            <div class="d-flex flex-column gap-3 h-100">
              <kep-card>
                <div class="card-header">
                  <div class="card-title d-flex align-items-center gap-1">
                    <kep-icon name="ranking" size="small-3"></kep-icon>
                    {{ 'Contests.UserStats.ContestRanks' | translate }}
                  </div>
                </div>
                <div class="card-body d-flex flex-column gap-3">
                  @if (statistics.contestRanks?.best) {
                    <div class="border rounded p-2">
                      <div class="text-uppercase text-success small fw-semibold mb-1">{{ 'Contests.UserStats.BestRank' | translate }}</div>
                      <div class="d-flex align-items-center gap-2 flex-wrap">
                        <span class="badge bg-success">#{{ statistics.contestRanks.best.rank }}</span>
                        <a class="fw-semibold text-body" [routerLink]="Resources.Contest | resourceById:statistics.contestRanks.best.contestId">
                          {{ statistics.contestRanks.best.contestTitle }}
                        </a>
                      </div>
                      <div class="text-muted small mt-1">
                        {{ 'Contests.UserStats.Contestants' | translate:{ count: statistics.contestRanks.best.participantsCount } }}
                      </div>
                    </div>
                  }

                  @if (statistics.contestRanks?.worst) {
                    <div class="border rounded p-2">
                      <div class="text-uppercase text-danger small fw-semibold mb-1">{{ 'Contests.UserStats.WorstRank' | translate }}</div>
                      <div class="d-flex align-items-center gap-2 flex-wrap">
                        <span class="badge bg-danger">#{{ statistics.contestRanks.worst.rank }}</span>
                        <a class="fw-semibold text-body" [routerLink]="Resources.Contest | resourceById:statistics.contestRanks.worst.contestId">
                          {{ statistics.contestRanks.worst.contestTitle }}
                        </a>
                      </div>
                      <div class="text-muted small mt-1">
                        {{ 'Contests.UserStats.Contestants' | translate:{ count: statistics.contestRanks.worst.participantsCount } }}
                      </div>
                    </div>
                  }

                  @if (!statistics.contestRanks?.best && !statistics.contestRanks?.worst) {
                    <div class="text-muted small">{{ 'Contests.UserStats.NoData' | translate }}</div>
                  }
                </div>
              </kep-card>

              <kep-card class="flex-grow-1">
                <div class="card-header">
                  <div class="card-title d-flex align-items-center gap-1">
                    <kep-icon name="rating" size="small-3"></kep-icon>
                    {{ 'Contests.UserStats.RatingChanges' | translate }}
                  </div>
                </div>
                <div class="card-body d-flex flex-column gap-3">
                  @if (statistics.contestDeltas?.best) {
                    <div class="border rounded p-2">
                      <div class="text-uppercase text-success small fw-semibold mb-1">{{ 'Contests.UserStats.BestDelta' | translate }}</div>
                      <div class="d-flex align-items-center gap-2 flex-wrap">
                        <span [class]="getDeltaBadgeClass(statistics.contestDeltas.best.delta)">
                          {{ formatDelta(statistics.contestDeltas.best.delta) }}
                        </span>
                        <a class="fw-semibold text-body" [routerLink]="Resources.Contest | resourceById:statistics.contestDeltas.best.contestId">
                          {{ statistics.contestDeltas.best.contestTitle }}
                        </a>
                      </div>
                      <div class="text-muted small mt-1">
                        {{ 'Contests.UserStats.Contestants' | translate:{ count: statistics.contestDeltas.best.participantsCount } }}
                      </div>
                    </div>
                  }

                  @if (statistics.contestDeltas?.worst) {
                    <div class="border rounded p-2">
                      <div class="text-uppercase text-danger small fw-semibold mb-1">{{ 'Contests.UserStats.WorstDelta' | translate }}</div>
                      <div class="d-flex align-items-center gap-2 flex-wrap">
                        <span [class]="getDeltaBadgeClass(statistics.contestDeltas.worst.delta)">
                          {{ formatDelta(statistics.contestDeltas.worst.delta) }}
                        </span>
                        <a class="fw-semibold text-body" [routerLink]="Resources.Contest | resourceById:statistics.contestDeltas.worst.contestId">
                          {{ statistics.contestDeltas.worst.contestTitle }}
                        </a>
                      </div>
                      <div class="text-muted small mt-1">
                        {{ 'Contests.UserStats.Contestants' | translate:{ count: statistics.contestDeltas.worst.participantsCount } }}
                      </div>
                    </div>
                  }

                  @if (!statistics.contestDeltas?.best && !statistics.contestDeltas?.worst) {
                    <div class="text-muted small">{{ 'Contests.UserStats.NoData' | translate }}</div>
                  }
                </div>
              </kep-card>
            </div>
          </div>
        </div>

        <div class="row g-3">
          <div class="col-12 col-xl-8">
            <kep-card>
              <div class="card-header">
                <div class="card-title d-flex align-items-center gap-1">
                  <kep-icon name="attempts" size="small-3"></kep-icon>
                  {{ 'Contests.AttemptsTimeline' | translate }}
                </div>
              </div>
              <div class="card-body">
                @if (timelineChart) {
                  <apex-chart [options]="timelineChart"></apex-chart>
                } @else {
                  <div class="text-muted small">{{ 'Contests.UserStats.NoData' | translate }}</div>
                }
              </div>
            </kep-card>
          </div>

          <div class="col-12 col-xl-4">
            <kep-card>
              <div class="card-header">
                <div class="card-title d-flex align-items-center gap-1">
                  <kep-icon name="lang" size="small-3"></kep-icon>
                  {{ 'Contests.UserStats.Languages' | translate }}
                </div>
              </div>
              <div class="card-body d-flex flex-column gap-2">
                @if (statistics.languages?.length) {
                  @for (language of statistics.languages; track language.lang) {
                    <div class="d-flex flex-column gap-1">
                      <div class="d-flex justify-content-between align-items-center small fw-semibold">
                        <span>{{ language.langFull }}</span>
                        <span>{{ language.attemptsCount | number }}</span>
                      </div>
                      <div class="progress" [style.height.px]="6">
                        <div
                          class="progress-bar"
                          role="progressbar"
                          [style.width.%]="getLanguagePercentage(language)"
                          [style.backgroundColor]="getLanguageColor(language.lang)">
                        </div>
                      </div>
                    </div>
                  }
                } @else {
                  <div class="text-muted small">{{ 'Contests.UserStats.NoData' | translate }}</div>
                }
              </div>
            </kep-card>

            <kep-card>
              <div class="card-header">
                <div class="card-title d-flex align-items-center gap-1">
                  <kep-icon name="verdict" size="small-3"></kep-icon>
                  {{ 'Contests.UserStats.Verdicts' | translate }}
                </div>
              </div>
              <div class="card-body d-flex flex-column gap-2">
                @if (statistics.verdicts?.length) {
                  @for (verdict of statistics.verdicts; track verdict.verdict) {
                    <div class="d-flex flex-column gap-1">
                      <div class="d-flex justify-content-between align-items-center small fw-semibold">
                        <span>{{ getVerdictTranslationKey(verdict.verdict) | translate }}</span>
                        <span>{{ verdict.attemptsCount | number }}</span>
                      </div>
                      <div class="progress" [style.height.px]="6">
                        <div
                          class="progress-bar"
                          role="progressbar"
                          [style.width.%]="getVerdictPercentage(verdict)"
                          [style.backgroundColor]="getVerdictColor(verdict.verdict)">
                        </div>
                      </div>
                    </div>
                  }
                } @else {
                  <div class="text-muted small">{{ 'Contests.UserStats.NoData' | translate }}</div>
                }
              </div>
            </kep-card>
          </div>
        </div>

        <div class="row g-3">
          <div class="col-12 col-lg-6">
            <kep-card>
              <div class="card-header">
                <div class="card-title d-flex align-items-center gap-1">
                  <kep-icon name="problem" size="small-3"></kep-icon>
                  {{ 'Contests.UserStats.UnsolvedProblems' | translate }}
                </div>
              </div>
              <div class="card-body">
                @if (statistics.unsolvedProblems?.length) {
                  <div class="d-flex flex-column gap-2">
                    @for (problem of statistics.unsolvedProblems; track problem.contestId + '-' + problem.problemSymbol) {
                      <div class="d-flex flex-column">
                        <a class="fw-semibold text-body" [routerLink]="Resources.Contest | resourceById:problem.contestId">
                          {{ problem.contestTitle }}
                        </a>
                        <div class="text-muted small">
                          {{ 'Contests.UserStats.ProblemSymbol' | translate:{ symbol: problem.problemSymbol } }}
                        </div>
                      </div>
                    }
                  </div>
                } @else {
                  <div class="text-muted small">{{ 'Contests.UserStats.NoData' | translate }}</div>
                }
              </div>
            </kep-card>
          </div>

          <div class="col-12 col-lg-6">
            <kep-card>
              <div class="card-header">
                <div class="card-title d-flex align-items-center gap-1">
                  <kep-icon name="tags" size="small-3"></kep-icon>
                  {{ 'Contests.UserStats.Tags' | translate }}
                </div>
              </div>
              <div class="card-body">
                @if (statistics.tags?.length) {
                  <div class="d-flex flex-wrap gap-2">
                    @for (tag of statistics.tags | slice:0:20; track tag.name) {
                      <span class="badge bg-light-primary text-body fw-semibold">
                        {{ tag.name }}
                        <span class="text-muted ms-1">{{ tag.solved }}</span>
                      </span>
                    }
                  </div>
                } @else {
                  <div class="text-muted small">{{ 'Contests.UserStats.NoData' | translate }}</div>
                }
              </div>
            </kep-card>

            <kep-card>
              <div class="card-header">
                <div class="card-title d-flex align-items-center gap-1">
                  <kep-icon name="statistics" size="small-3"></kep-icon>
                  {{ 'Contests.UserStats.Symbols' | translate }}
                </div>
              </div>
              <div class="card-body">
                @if (statistics.symbols?.length) {
                  <div class="d-flex flex-wrap gap-2">
                    @for (symbol of statistics.symbols; track symbol.symbol) {
                      <span class="badge bg-light-info text-body fw-semibold">
                        {{ symbol.symbol }}
                        <span class="text-muted ms-1">{{ symbol.solved }}</span>
                      </span>
                    }
                  </div>
                } @else {
                  <div class="text-muted small">{{ 'Contests.UserStats.NoData' | translate }}</div>
                }
              </div>
            </kep-card>
          </div>
        </div>

        <div class="row g-3">
          <div class="col-12 col-xl-6">
            <kep-card>
              <div class="card-header">
                <div class="card-title d-flex align-items-center gap-1">
                  <kep-icon name="attempts" size="small-3"></kep-icon>
                  {{ 'Contests.UserStats.TopAttempts' | translate }}
                </div>
              </div>
              <div class="card-body">
                @if (statistics.topAttempts?.length) {
                  <div class="table-responsive">
                    <table class="table table-sm mb-0">
                      <thead>
                      <tr>
                        <th>{{ 'Contests.Contest' | translate }}</th>
                        <th>{{ 'Problem' | translate }}</th>
                        <th class="text-end">{{ 'Attempts' | translate }}</th>
                        <th class="text-end">{{ 'Result' | translate }}</th>
                      </tr>
                      </thead>
                      <tbody>
                      @for (attempt of statistics.topAttempts; track attempt.contestId + '-' + attempt.problemSymbol) {
                        <tr>
                          <td>
                            <a class="text-body fw-semibold" [routerLink]="Resources.Contest | resourceById:attempt.contestId">
                              {{ attempt.contestTitle }}
                            </a>
                          </td>
                          <td>{{ attempt.problemSymbol }}</td>
                          <td class="text-end">{{ attempt.attemptsCount | number }}</td>
                          <td class="text-end">
                            @if (attempt.solved) {
                              <span class="badge bg-success">{{ 'Contests.UserStats.SolvedLabel' | translate }}</span>
                            } @else {
                              <span class="badge bg-danger">{{ 'Contests.UserStats.UnsolvedLabel' | translate }}</span>
                            }
                          </td>
                        </tr>
                      }
                      </tbody>
                    </table>
                  </div>
                } @else {
                  <div class="text-muted small">{{ 'Contests.UserStats.NoData' | translate }}</div>
                }
              </div>
            </kep-card>
          </div>

          <div class="col-12 col-xl-6">
            <kep-card>
              <div class="card-header">
                <div class="card-title d-flex align-items-center gap-1">
                  <kep-icon name="users" size="small-3"></kep-icon>
                  {{ 'Contests.UserStats.WorthyOpponents' | translate }}
                </div>
              </div>
              <div class="card-body d-flex flex-column gap-3">
                @if (statistics.worthyOpponents?.length) {
                  @for (opponent of statistics.worthyOpponents; track opponent.opponent) {
                    <div class="border rounded p-2">
                      <div class="d-flex justify-content-between align-items-center gap-2 flex-wrap">
                        <span class="fw-semibold">{{ opponent.opponent }}</span>
                        <span class="badge bg-primary">
                          {{ 'Contests.UserStats.SharedContests' | translate:{ count: opponent.sharedCount } }}
                        </span>
                      </div>
                      <div class="mt-2 d-flex flex-column gap-2">
                        @for (contest of opponent.contests; track contest.contestId) {
                          <div class="d-flex flex-column">
                            <a class="fw-semibold text-body" [routerLink]="Resources.Contest | resourceById:contest.contestId">
                              {{ contest.contestTitle }}
                            </a>
                            <div class="text-muted small">
                              {{ 'Contests.UserStats.OpponentContestResult' | translate:{
                                userRank: contest.userRank,
                                opponentRank: contest.opponentRank,
                                userPoints: contest.userPoints,
                                opponentPoints: contest.opponentPoints,
                              } }}
                            </div>
                          </div>
                        }
                      </div>
                    </div>
                  }
                } @else {
                  <div class="text-muted small">{{ 'Contests.UserStats.NoData' | translate }}</div>
                }
              </div>
            </kep-card>
          </div>
        </div>
      </section>
    } @else {
      <kep-card>
        <div class="card-body text-center py-5 text-muted">{{ 'NoResultFound' | translate }}</div>
      </kep-card>
    }
  </div>
</div>
