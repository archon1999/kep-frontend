<div class="content-wrapper container-xxl p-0 {{ contest | contestClasses }}">
  <div class="content-body">
    <app-content-header [contentHeader]="contentHeader"/>

    <div class="row g-1">
      <div class="col-12">
        <kep-card>
          <div class="card-header p-1">
            <contest-tab [contest]="contest"/>
          </div>
        </kep-card>
      </div>
    </div>

    @if (isLoading && !statistics) {
      <kep-card class="mt-1">
        <div class="card-body d-flex justify-content-center align-items-center" style="min-height: 320px;">
          <spinner></spinner>
        </div>
      </kep-card>
    } @else if (statistics) {
      <div class="row g-1 mt-1">
        @for (card of summaryCards; track card.key) {
          <div class="col-12 col-sm-6 col-md-6 col-xl-3">
            <kep-card>
              <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                  <div class="text-muted text-uppercase fw-semibold font-small-4">{{ card.labelKey | translate }}</div>
                  <div class="text-dark fw-semibold fs-3">
                    {{ card.value | number:(card.numberFormat ? card.numberFormat : '1.0-0') }}
                    @if (card.suffix) {
                      <span class="fs-6 ms-1">{{ card.suffix }}</span>
                    }
                  </div>
                </div>
                <div class="avatar avatar-rounded avatar-lg p-50 d-flex align-items-center justify-content-center"
                     [ngClass]="card.iconClass">
                  <kep-icon [name]="card.icon" class="font-large-1"></kep-icon>
                </div>
              </div>
            </kep-card>
          </div>
        }
      </div>

      <div class="row g-1 mt-1">
        <div class="col-12 col-lg-7 col-xl-8">
          <kep-card>
            <div class="card-header d-flex justify-content-between align-items-center">
              <h4 class="card-title mb-0">{{ 'Contests.AttemptsTimeline' | translate }}</h4>
            </div>
            <div class="card-body">
              @if (timelineChart?.series?.[0]?.data?.length) {
                <apex-chart [options]="timelineChart"></apex-chart>
              } @else {
                <div class="text-center text-muted py-2">{{ 'Contests.NotAvailable' | translate }}</div>
              }
            </div>
          </kep-card>
        </div>
        <div class="col-12 col-lg-5 col-xl-4">
          <kep-card>
            <div class="card-header d-flex justify-content-between align-items-center">
              <h4 class="card-title mb-0">{{ 'Contests.VerdictDistribution' | translate }}</h4>
            </div>
            <div class="card-body">
              <apex-chart [options]="verdictChart"></apex-chart>
            </div>
            <div class="card-footer bg-transparent border-top">
              <div class="d-flex flex-column gap-1">
                <div class="d-flex justify-content-between text-muted">
                  <span>{{ 'Contests.VerdictAccepted' | translate }}</span>
                  <span class="fw-semibold text-dark">{{ statistics.verdicts.accepted | number }}</span>
                </div>
                <div class="d-flex justify-content-between text-muted">
                  <span>{{ 'Contests.VerdictWrongAnswer' | translate }}</span>
                  <span class="fw-semibold text-dark">{{ statistics.verdicts.wrongAnswer | number }}</span>
                </div>
                <div class="d-flex justify-content-between text-muted">
                  <span>{{ 'Contests.VerdictTimeLimitExceeded' | translate }}</span>
                  <span class="fw-semibold text-dark">{{ statistics.verdicts.timeLimitExceeded | number }}</span>
                </div>
                <div class="d-flex justify-content-between text-muted">
                  <span>{{ 'Contests.VerdictOther' | translate }}</span>
                  <span class="fw-semibold text-dark">{{ statistics.verdicts.other | number }}</span>
                </div>
              </div>
            </div>
          </kep-card>
        </div>
      </div>

      <div class="row g-1 mt-1">
        <div class="col-12">
          <kep-card>
            <div class="card-header d-flex justify-content-between align-items-center">
              <h4 class="card-title mb-0">{{ 'Contests.AttemptsByProblem' | translate }}</h4>
            </div>
            <div class="card-body">
              @if (problemsChart?.series?.[0]?.data?.length) {
                <apex-chart [options]="problemsChart"></apex-chart>
              } @else {
                <div class="text-center text-muted py-2">{{ 'Contests.NotAvailable' | translate }}</div>
              }
            </div>
            @if (problemSummary.length) {
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead class="table-light">
                    <tr>
                      <th scope="col">{{ 'Problem' | translate }}</th>
                      <th scope="col" class="text-end">{{ 'Attempts' | translate }}</th>
                      <th scope="col" class="text-end">{{ 'Contests.Accepted' | translate }}</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (row of problemSummary; track row.symbol) {
                      <tr>
                        <td class="fw-semibold text-dark">{{ row.symbol }}</td>
                        <td class="text-end">{{ row.attempts | number }}</td>
                        <td class="text-end text-success">{{ row.accepted | number }}</td>
                      </tr>
                    }
                  </tbody>
                </table>
              </div>
            }
          </kep-card>
        </div>
      </div>

      <div class="row g-1 mt-1">
        <div class="col-12 col-xl-7">
          <kep-card>
            <div class="card-header d-flex justify-content-between align-items-center">
              <h4 class="card-title mb-0">{{ 'Contests.FirstSolves' | translate }}</h4>
            </div>
            <div class="card-body p-0">
              @if (firstSolves.length) {
                <div class="table-responsive">
                  <table class="table table-sm mb-0 align-middle">
                    <thead class="table-light">
                      <tr>
                        <th scope="col">{{ 'Problem' | translate }}</th>
                        <th scope="col">{{ 'Contests.Contestant' | translate }}</th>
                        <th scope="col" class="text-end">{{ 'Time' | translate }}</th>
                      </tr>
                    </thead>
                    <tbody>
                      @for (entry of firstSolves; track entry.problem) {
                        <tr>
                          <td class="fw-semibold text-dark">{{ entry.problem }}</td>
                          <td>
                            <user-popover [customContent]="true" [username]="entry.record.contestant.user.username">
                              <div class="d-flex align-items-center">
                                <div class="avatar avatar-sm avatar-rounded me-1 flex-shrink-0">
                                  <img [src]="entry.record.contestant.user.avatar" alt="Avatar">
                                </div>
                                <div>
                                  <div class="fw-semibold text-dark">{{ entry.record.contestant.user.userFullName || entry.record.contestant.user.username }}</div>
                                  @if (entry.record.contestant.user.ratingTitle) {
                                    <div class="text-muted font-small-3">{{ entry.record.contestant.user.ratingTitle }}</div>
                                  }
                                </div>
                              </div>
                            </user-popover>
                          </td>
                          <td class="text-end text-muted">{{ entry.record.time }}</td>
                        </tr>
                      }
                    </tbody>
                  </table>
                </div>
              } @else {
                <div class="p-2 text-center text-muted">{{ 'Contests.NotAvailable' | translate }}</div>
              }
            </div>
          </kep-card>
        </div>
        <div class="col-12 col-xl-5">
          <kep-card>
            <div class="card-header d-flex justify-content-between align-items-center">
              <h4 class="card-title mb-0">{{ 'Contests.Records' | translate }}</h4>
            </div>
            <div class="card-body d-flex flex-column gap-2">
              <div>
                <div class="text-muted text-uppercase font-small-4 fw-semibold">{{ 'Contests.LastAccepted' | translate }}</div>
                @if (lastAccepted) {
                  <div class="d-flex align-items-center mt-1">
                    <user-popover [customContent]="true" [username]="lastAccepted.contestant.user.username">
                      <div class="d-flex align-items-center">
                        <div class="avatar avatar-sm avatar-rounded me-1 flex-shrink-0">
                          <img [src]="lastAccepted.contestant.user.avatar" alt="Avatar">
                        </div>
                        <div>
                          <div class="fw-semibold text-dark">{{ lastAccepted.contestant.user.userFullName || lastAccepted.contestant.user.username }}</div>
                          <div class="text-muted font-small-3">{{ 'Problem' | translate }}: <span class="fw-semibold text-dark">{{ lastAccepted.problem }}</span></div>
                        </div>
                      </div>
                    </user-popover>
                    <div class="ms-auto text-muted font-small-3">{{ lastAccepted.time }}</div>
                  </div>
                } @else {
                  <div class="text-muted">{{ 'Contests.NotAvailable' | translate }}</div>
                }
              </div>
              <div>
                <div class="text-muted text-uppercase font-small-4 fw-semibold">{{ 'Contests.MostAttempts' | translate }}</div>
                @if (mostAttempts) {
                  <div class="d-flex align-items-center mt-1">
                    <user-popover [customContent]="true" [username]="mostAttempts.contestant.user.username">
                      <div class="d-flex align-items-center">
                        <div class="avatar avatar-sm avatar-rounded me-1 flex-shrink-0">
                          <img [src]="mostAttempts.contestant.user.avatar" alt="Avatar">
                        </div>
                        <div>
                          <div class="fw-semibold text-dark">{{ mostAttempts.contestant.user.userFullName || mostAttempts.contestant.user.username }}</div>
                          <div class="text-muted font-small-3">{{ 'Attempts' | translate }}: <span class="fw-semibold text-dark">{{ mostAttempts.attempts }}</span></div>
                        </div>
                      </div>
                    </user-popover>
                  </div>
                } @else {
                  <div class="text-muted">{{ 'Contests.NotAvailable' | translate }}</div>
                }
              </div>
            </div>
          </kep-card>
        </div>
      </div>

      <div class="row g-1 mt-1">
        <div class="col-12">
          <kep-card>
            <div class="card-header d-flex justify-content-between align-items-center">
              <h4 class="card-title mb-0">{{ 'Contests.BadgesTitle' | translate }}</h4>
            </div>
            <div class="card-body">
              @if (badgeEntries.length) {
                <div class="row g-1">
                  @for (badge of badgeEntries; track badge.key) {
                    <div class="col-12 col-md-6 col-xl-3">
                      <div class="border rounded p-1 h-100">
                        <div class="text-muted text-uppercase font-small-4 fw-semibold">{{ badge.labelKey | translate }}</div>
                        <div class="d-flex align-items-center mt-1">
                          <user-popover [customContent]="true" [username]="badge.badge.contestant.user.username">
                            <div class="d-flex align-items-center">
                              <div class="avatar avatar-sm avatar-rounded me-1 flex-shrink-0">
                                <img [src]="badge.badge.contestant.user.avatar" alt="Avatar">
                              </div>
                              <div>
                                <div class="fw-semibold text-dark">{{ badge.badge.contestant.user.userFullName || badge.badge.contestant.user.username }}</div>
                                @if (badge.badge.contestant.user.ratingTitle) {
                                  <div class="text-muted font-small-3">{{ badge.badge.contestant.user.ratingTitle }}</div>
                                }
                              </div>
                            </div>
                          </user-popover>
                        </div>
                        <ul class="list-unstyled mb-0 mt-1 text-muted font-small-3">
                          @if (badge.badge.problem) {
                            <li>{{ 'Problem' | translate }}: <span class="text-dark fw-semibold">{{ badge.badge.problem }}</span></li>
                          }
                          @if (badge.badge.attempts !== undefined) {
                            <li>{{ 'Attempts' | translate }}: <span class="text-dark fw-semibold">{{ badge.badge.attempts }}</span></li>
                          }
                          @if (badge.badge.wrongAttempts !== undefined) {
                            <li>{{ 'Contests.WrongAttempts' | translate }}: <span class="text-dark fw-semibold">{{ badge.badge.wrongAttempts }}</span></li>
                          }
                          @if (badge.badge.solvedProblems !== undefined) {
                            <li>{{ 'Contests.SolvedProblems' | translate }}: <span class="text-dark fw-semibold">{{ badge.badge.solvedProblems }}</span></li>
                          }
                          @if (badge.badge.time) {
                            <li>{{ 'Time' | translate }}: <span class="text-dark fw-semibold">{{ badge.badge.time }}</span></li>
                          }
                        </ul>
                      </div>
                    </div>
                  }
                </div>
              } @else {
                <div class="text-center text-muted">{{ 'Contests.NotAvailable' | translate }}</div>
              }
            </div>
          </kep-card>
        </div>
      </div>
    } @else {
      <kep-card class="mt-1">
        <div class="card-body text-center text-muted">{{ 'Contests.NotAvailable' | translate }}</div>
      </kep-card>
    }
  </div>
</div>
