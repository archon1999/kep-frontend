<div class="content-wrapper container-xxl p-0 {{ contest | contestClasses }}">
  <div class="content-body">
    <app-content-header [contentHeader]="contentHeader"></app-content-header>

    <kep-card>
      <div class="card-header p-1">
        <contest-tab [contest]="contest"></contest-tab>
      </div>
    </kep-card>

    @if (isLoading) {
      <kep-card [cardHeight]="'320px'">
        <div class="card-body d-flex align-items-center justify-content-center">
          <spinner></spinner>
        </div>
      </kep-card>
    } @else if (statistics) {
      <div class="row g-2 g-lg-3">
        @for (card of overviewCards; track card.key) {
          <div class="col-sm-6 col-xl-3">
            <kep-card>
              <div class="card-body">
                <div class="d-flex align-items-start justify-content-between gap-1">
                  <div>
                    <p class="text-muted text-uppercase fw-semibold mb-0 small">{{ card.label | translate }}</p>
                    <h4 class="fw-bolder mt-1 mb-0">
                      @if (card.format === 'percent') {
                        {{ card.value | number:'1.0-2' }}%
                      } @else {
                        {{ card.value | number }}
                      }
                    </h4>
                  </div>
                  <div class="avatar p-50 m-0 bg-light-{{ card.iconColor }} rounded">
                    <div class="avatar-content">
                      <kep-icon [name]="card.icon" [color]="card.iconColor"></kep-icon>
                    </div>
                  </div>
                </div>
              </div>
            </kep-card>
          </div>
        }
      </div>

      <div class="row g-2 g-lg-3 mt-0 mt-lg-2">
        <div class="col-lg-8">
          <kep-card>
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-1">
                <h5 class="card-title mb-0">{{ 'Contests.AttemptsTimeline' | translate }}</h5>
                <span class="text-muted small">{{ statistics.general.attempts.total | number }} {{ 'Attempts' | translate }}</span>
              </div>
              <apex-chart [options]="timelineChart"></apex-chart>
            </div>
          </kep-card>
        </div>
        <div class="col-lg-4">
          <kep-card>
            <div class="card-body">
              <h5 class="card-title mb-1">{{ 'Contests.VerdictDistribution' | translate }}</h5>
              <apex-chart [options]="verdictsChart"></apex-chart>
            </div>
          </kep-card>
        </div>
      </div>

      <div class="row g-2 g-lg-3 mt-0 mt-lg-2">
        <div class="col-lg-8">
          <kep-card>
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-1">
                <h5 class="card-title mb-0">{{ 'Contests.ProblemAttempts' | translate }}</h5>
                <span class="text-muted small">{{ statistics.general.accepted.total | number }} {{ 'Solved' | translate }}</span>
              </div>
              <apex-chart [options]="problemsChart"></apex-chart>
            </div>
          </kep-card>
        </div>
        <div class="col-lg-4">
          <kep-card>
            <div class="card-body h-100 d-flex flex-column">
              <h5 class="card-title mb-1">{{ 'Contests.Badges' | translate }}</h5>
              <div class="d-flex flex-column gap-1 flex-grow-1">
                @if (badges.length) {
                  @for (badge of badges; track badge.key) {
                    <div class="border rounded p-1">
                      <div class="d-flex align-items-start gap-1">
                        <div class="avatar p-50 m-0 bg-light-{{ badge.color }} rounded">
                          <div class="avatar-content">
                            <kep-icon [name]="badge.icon" [color]="badge.color"></kep-icon>
                          </div>
                        </div>
                        <div class="flex-grow-1">
                          <div class="fw-semibold mb-25">{{ badge.title | translate }}</div>
                          <contestant-view [user]="badge.contestant?.user" [team]="badge.contestant?.team" [imgSize]="28"></contestant-view>
                          <div class="text-muted small mt-25">
                            @switch (badge.key) {
                              @case ('sniper') {
                                {{ 'Problem' | translate }} {{ badge.problem }} · {{ badge.time }}
                              }
                              @case ('grinder') {
                                {{ 'Attempts' | translate }}: {{ badge.attempts | number }}
                              }
                              @case ('optimizer') {
                                {{ 'Contests.BadgeOptimizerDetails' | translate:{ solved: badge.solvedProblems, wrong: badge.wrongAttempts } }}
                              }
                              @case ('neverGiveUp') {
                                {{ 'Problem' | translate }} {{ badge.problem }} · {{ badge.attempts | number }} {{ 'Attempts' | translate }}
                              }
                            }
                          </div>
                        </div>
                      </div>
                    </div>
                  }
                } @else {
                  <div class="text-muted small">{{ 'Contests.NoBadges' | translate }}</div>
                }
              </div>
            </div>
          </kep-card>
        </div>
      </div>

      <div class="row g-2 g-lg-3 mt-0 mt-lg-2">
        <div class="col-lg-8">
          <kep-card>
            <div class="card-body">
              <h5 class="card-title mb-1">{{ 'Contests.FirstSolves' | translate }}</h5>
              <div class="table-responsive">
                <table class="table table-sm align-middle mb-0">
                  <thead>
                  <tr>
                    <th class="text-uppercase small text-muted">{{ 'Problem' | translate }}</th>
                    <th class="text-uppercase small text-muted">{{ 'Contests.Contestant' | translate }}</th>
                    <th class="text-uppercase small text-muted text-end">{{ 'Time' | translate }}</th>
                  </tr>
                  </thead>
                  <tbody>
                  @if (firstSolvesEntries.length) {
                    @for (entry of firstSolvesEntries; track entry.problem) {
                      <tr>
                        <td class="fw-semibold">{{ entry.problem }}</td>
                        <td>
                          <contestant-view [user]="entry.record.contestant?.user" [team]="entry.record.contestant?.team"></contestant-view>
                        </td>
                        <td class="text-end text-nowrap">{{ entry.record.time }}</td>
                      </tr>
                    }
                  } @else {
                    <tr>
                      <td colspan="3" class="text-center text-muted py-2">{{ 'Contests.NoFirstSolves' | translate }}</td>
                    </tr>
                  }
                  </tbody>
                </table>
              </div>
            </div>
          </kep-card>
        </div>
        <div class="col-lg-4">
          <kep-card>
            <div class="card-body d-flex flex-column gap-1">
              <h5 class="card-title mb-1">{{ 'Contests.Facts' | translate }}</h5>
              @if (facts.length) {
                <ul class="mb-0 ps-2">
                  @for (fact of facts; track $index) {
                    <li class="mb-25">{{ fact }}</li>
                  }
                </ul>
              } @else {
                <div class="text-center text-muted small py-1">{{ 'Contests.NoFacts' | translate }}</div>
              }
            </div>
          </kep-card>
        </div>
      </div>
    }
  </div>
</div>
